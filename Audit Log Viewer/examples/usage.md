# Integration Example

This example shows how to wire `AuditLogViewer` into an existing React + ICP
project that already has a canister actor.

---

## Scenario

You have an existing canister (`my_app`) that records operations to a stable
buffer. You want to add the audit log viewer to your admin panel.

---

## Step 1 -- Add the query functions to your Motoko canister

```motoko
// In your existing actor (my_app/main.mo)

type AuditEntry = {
  timestamp : Int;
  principal : Text;
  action    : Text;
  entity    : Text;
};

// Your existing stable log buffer
stable var logBuffer : [AuditEntry] = [];

// Append from your update functions:
//   logBuffer := Array.append(logBuffer, [{
//     timestamp = Time.now() / 1_000_000;
//     principal = Principal.toText(caller);
//     action    = "record.create";
//     entity    = "Invoice:" # Nat.toText(newId);
//   }]);

public query func getAuditLogs(page : Nat, pageSize : Nat) : async {
  entries : [AuditEntry];
  total   : Nat;
} {
  let start   = page * pageSize;
  let logSize = logBuffer.size();
  let end     = if (start + pageSize > logSize) { logSize } else { start + pageSize };
  let entries = if (start >= logSize) { [] } else {
    Array.tabulate(end - start, func(i : Nat) : AuditEntry { logBuffer[start + i] })
  };
  { entries; total = logSize };
};

public query ({ caller }) func getMyRole() : async Text {
  // Replace with your own RBAC lookup
  switch (roleStore.get(caller)) {
    case (?role) { role };
    case null    { "user" };
  }
};
```

---

## Step 2 -- Install frontend dependencies

```sh
npm install @tanstack/react-query lucide-react
# shadcn/ui Table, Button, Badge, Skeleton components must also be present
```

---

## Step 3 -- Copy the component

Copy `frontend/src/AuditLogViewer.tsx` into your project's component directory.

---

## Step 4 -- Wire the actor

```tsx
// AdminPanel.tsx
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { createActor } from "../declarations/my_app";   // generated by dfx
import AuditLogViewer from "./AuditLogViewer";

const queryClient = new QueryClient();

// Create the actor (replace with your canister ID and agent setup)
const actor = createActor(process.env.CANISTER_ID_MY_APP!, {
  agentOptions: { host: "https://icp0.io" },
});

export default function AdminPanel() {
  return (
    <QueryClientProvider client={queryClient}>
      <div className="container max-w-5xl mx-auto px-4 py-8">
        <h1 className="text-2xl font-semibold mb-6">System Audit Log</h1>
        <AuditLogViewer actor={actor} pageSize={10} />
      </div>
    </QueryClientProvider>
  );
}
```

---

## Step 5 -- Verify

1. Sign in with an admin principal. The table renders with page controls.
2. Sign in with any other principal. The access-denied screen renders.
3. Navigate between pages. Each page fetches a fresh slice from the canister.

---

## RBAC integration note

In the example above, `getMyRole()` uses a `roleStore` TrieMap. In the full
platform this is a per-entity RBAC system with `admin / editor / viewer` tiers,
inherited through a portfolio > program > project hierarchy. The viewer
component itself is unchanged -- only the `getMyRole()` implementation differs.

